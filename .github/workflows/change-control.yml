name: üöÄ Change Control & Documentation

on:
  pull_request:
    branches:
      - main
      - master
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: read
  issues: read

jobs:
  generate-documentation:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Salva title/body em arquivos (N√ÉO usa output multilinha)
      - name: üîí Ler dados do PR (safe)
        id: pr
        shell: bash
        run: |
          set -euo pipefail

          jq -r '.pull_request.title // ""' "$GITHUB_EVENT_PATH" > pr_title.txt
          jq -r '.pull_request.body // ""'  "$GITHUB_EVENT_PATH" > pr_body.txt

          PR_NUMBER="$(jq -r '.pull_request.number // ""' "$GITHUB_EVENT_PATH")"
          PR_URL="$(jq -r '.pull_request.html_url // ""' "$GITHUB_EVENT_PATH")"

          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "url=$PR_URL" >> "$GITHUB_OUTPUT"

          echo "PR salvo em pr_title.txt / pr_body.txt"

      - name: Validar ticket GLPI
        id: validate-ticket
        shell: bash
        run: |
          set -euo pipefail

          PR_TITLE="$(cat pr_title.txt)"
          PR_BODY="$(cat pr_body.txt)"

          TICKET="$(printf '%s\n' "$PR_TITLE $PR_BODY" | grep -oE "GLPI-[0-9]+" | head -n 1 || true)"

          if [ -z "$TICKET" ]; then
            echo "ERRO: O PR deve conter um ticket GLPI-XXXX no t√≠tulo ou descri√ß√£o."
            exit 1
          fi

          echo "ticket=$TICKET" >> "$GITHUB_OUTPUT"
          echo "Ticket encontrado: $TICKET"

      - name: üìã Validar campos obrigat√≥rios
        shell: bash
        run: |
          set -euo pipefail

          BODY="$(cat pr_body.txt)"

          check_section() {
            local section="$1"
            if ! printf '%s\n' "$BODY" | grep -iE "^###?[[:space:]]*$section[[:space:]]*$" > /dev/null; then
              echo "‚ùå ERRO: Se√ß√£o '$section' √© obrigat√≥ria no PR."
              exit 1
            fi
          }

          check_section "Como validar"
          check_section "Rollback"
          check_section "Impacto"

          echo "Todos os campos obrigat√≥rios est√£o presentes"

      - name: üìä Extrair metadados da release
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          DATE="$(date +%Y-%m-%d)"
          YEAR="$(date +%Y)"
          MONTH="$(date +%m)"
          TIMESTAMP="$(date +%s)"

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          REPO="${{ github.repository }}"

          LAST_VERSION=""
          if [ -f CHANGELOG.md ]; then
            LAST_VERSION="$(grep -m 1 -oE '## \[v[0-9]+\.[0-9]+\.[0-9]+\]' CHANGELOG.md \
              | sed -E 's/## \[(v[0-9]+\.[0-9]+\.[0-9]+)\]/\1/' || true)"
          fi

          if [ -z "$LAST_VERSION" ]; then
            MAJOR="0"
            MINOR="1"
            PATCH="0"
          else
            MAJOR="$(echo "$LAST_VERSION" | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\1/')"
            MINOR="$(echo "$LAST_VERSION" | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\2/')"
            PATCH="$(echo "$LAST_VERSION" | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\3/')"
            PATCH="$((PATCH + 1))"
          fi

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          PREV_VERSION="${LAST_VERSION:-N/A}"

          PR_TITLE="$(cat pr_title.txt)"
          RELEASE_NAME="Release ${NEW_VERSION} - ${PR_TITLE}"

          {
            echo "date=$DATE"
            echo "year=$YEAR"
            echo "month=$MONTH"
            echo "timestamp=$TIMESTAMP"
            echo "base_sha=$BASE_SHA"
            echo "head_sha=$HEAD_SHA"
            echo "repo=$REPO"
            echo "new_version=$NEW_VERSION"
            echo "prev_version=$PREV_VERSION"
            echo "release_name=$RELEASE_NAME"
          } >> "$GITHUB_OUTPUT"

          echo "Metadados gerados: $NEW_VERSION"

      - name: üë• Coletar aprova√ß√µes
        id: reviews
        shell: bash
        run: |
          set -euo pipefail

          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.pr.outputs.number }}/reviews"

          REVIEWS="$(curl -sS \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL")"

          APPROVED_BY_JSON="$(echo "$REVIEWS" | jq -c '[.[] | select(.state == "APPROVED") | .user.login] | unique')"
          APPROVED_COUNT="$(echo "$APPROVED_BY_JSON" | jq 'length')"

          if [ "$APPROVED_COUNT" -eq 0 ]; then
            APPROVED_BY_CSV="Aguardando aprova√ß√µes"
            APPROVED_BY_JSON='[]'
          else
            APPROVED_BY_CSV="$(echo "$APPROVED_BY_JSON" | jq -r 'join(", ")')"
          fi

          {
            echo "approved_by_json=$APPROVED_BY_JSON"
            echo "approved_by_csv=$APPROVED_BY_CSV"
            echo "approved_count=$APPROVED_COUNT"
          } >> "$GITHUB_OUTPUT"

          echo "Aprovadores: $APPROVED_BY_CSV"

      - name: üîß Analisar altera√ß√µes de c√≥digo
        id: code-analysis
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ steps.meta.outputs.base_sha }}"
          HEAD_SHA="${{ steps.meta.outputs.head_sha }}"

          CHANGED_FILES="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | sort -u || true)"
          FILE_COUNT="$(printf '%s\n' "$CHANGED_FILES" | sed '/^\s*$/d' | wc -l | tr -d ' ')"

          DIFF_STATS="$(git diff --shortstat "$BASE_SHA" "$HEAD_SHA" || true)"
          [ -z "$DIFF_STATS" ] && DIFF_STATS="0 files changed"

          COMMITS="$(git log --pretty=format:"%h - %s (%an)" "$BASE_SHA..$HEAD_SHA" || true)"
          COMMIT_COUNT="$(git rev-list --count "$BASE_SHA..$HEAD_SHA" || echo 0)"

          METHODS_ANALYSIS="$(git diff -U0 "$BASE_SHA" "$HEAD_SHA" \
            | grep -E '^\+.*(function|def|class|const|let|var|async|=>)' \
            | sed 's/^+//' | grep -v '^\s*$' | head -20 || true)"
          METHOD_COUNT="$(printf '%s\n' "$METHODS_ANALYSIS" | sed '/^\s*$/d' | wc -l | tr -d ' ')"

          LANGUAGES="$(git ls-files | grep -v '^docs/' | sed 's/.*\.//' | sort -u | tr '\n' ', ' | sed 's/, $//')"
          FILES_JSON="$(printf '%s\n' "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')"
          FILE_STATS="$(git diff --numstat "$BASE_SHA" "$HEAD_SHA" | awk '{print $1":"$2":"$3}' | tr '\n' '|' || true)"

          {
            echo "changed_files_json=$FILES_JSON"
            echo "file_count=$FILE_COUNT"
            echo "diff_stats=$DIFF_STATS"
            echo "commit_count=$COMMIT_COUNT"
            echo "method_count=$METHOD_COUNT"
            echo "languages=$LANGUAGES"
            echo "file_stats=$FILE_STATS"
          } >> "$GITHUB_OUTPUT"

          printf '%s\n' "$COMMITS" > commits.txt
          printf '%s\n' "$METHODS_ANALYSIS" > methods.txt

          echo "An√°lise de c√≥digo conclu√≠da: $FILE_COUNT arquivos, $COMMIT_COUNT commits"

      - name: üìù Extrair se√ß√µes do PR
        id: extract-sections
        shell: bash
        run: |
          set -euo pipefail

          PR_BODY="$(cat pr_body.txt)"

          extract_section() {
            local section="$1"
            printf '%s\n' "$PR_BODY" | awk -v title="$section" '
              BEGIN {found=0; IGNORECASE=1}
              tolower($0) ~ "^#+[[:space:]]*" tolower(title) "[[:space:]]*$" {found=1; next}
              found && /^#+[[:space:]]/ {exit}
              found {print}
            ' | sed '/^$/d' | head -20
          }

          HOW_TO_VALIDATE="$(extract_section "Como validar" | head -10)"
          IMPACT="$(extract_section "Impacto" | head -10)"
          ROLLBACK="$(extract_section "Rollback" | head -10)"

          [ -z "$HOW_TO_VALIDATE" ] && HOW_TO_VALIDATE="*Nenhum roteiro de valida√ß√£o fornecido. Recomenda-se adicionar casos de teste.*"
          [ -z "$IMPACT" ] && IMPACT="*Impacto n√£o descrito. Favor documentar o impacto desta mudan√ßa.*"
          [ -z "$ROLLBACK" ] && ROLLBACK="*Estrat√©gia de rollback n√£o documentada. Recomenda-se definir plano de revers√£o.*"

          printf '%s\n' "$HOW_TO_VALIDATE" > how_to_validate.txt
          printf '%s\n' "$IMPACT" > impact.txt
          printf '%s\n' "$ROLLBACK" > rollback.txt

          echo "Se√ß√µes extra√≠das com sucesso"

      - name: Gerar documenta√ß√£o markdown
        shell: bash
        run: |
          set -euo pipefail

          YEAR="${{ steps.meta.outputs.year }}"
          MONTH="${{ steps.meta.outputs.month }}"
          TICKET="${{ steps.validate-ticket.outputs.ticket }}"
          NEW_VERSION="${{ steps.meta.outputs.new_version }}"
          DATE="${{ steps.meta.outputs.date }}"
          REPO="${{ steps.meta.outputs.repo }}"
          BASE_SHA="${{ steps.meta.outputs.base_sha }}"
          HEAD_SHA="${{ steps.meta.outputs.head_sha }}"

          PR_TITLE="$(cat pr_title.txt)"

          DOC_DIR="docs/releases/$YEAR/$MONTH"
          mkdir -p "$DOC_DIR"
          DOC_FILE="$DOC_DIR/${TICKET}.md"

          HOW_TO_VALIDATE="$(cat how_to_validate.txt)"
          IMPACT="$(cat impact.txt)"
          ROLLBACK="$(cat rollback.txt)"
          COMMITS="$(cat commits.txt)"
          METHODS="$(cat methods.txt)"
          CHANGED_FILES='${{ steps.code-analysis.outputs.changed_files_json }}'

          METHODS_FORMATTED="$(printf '%s\n' "$METHODS" | sed 's/^/- /')"
          [ -z "$(echo "$METHODS_FORMATTED" | tr -d '[:space:]')" ] && METHODS_FORMATTED="- Nenhum m√©todo/fun√ß√£o novo identificado"

          COMMITS_FORMATTED="$(printf '%s\n' "$COMMITS" | sed 's/^/- /')"
          [ -z "$(echo "$COMMITS_FORMATTED" | tr -d '[:space:]')" ] && COMMITS_FORMATTED="- Nenhum commit no intervalo"

          FILES_FORMATTED="$(echo "$CHANGED_FILES" | jq -r '.[]' | sed 's/^/- üìÑ /')"
          [ -z "$(echo "$FILES_FORMATTED" | tr -d '[:space:]')" ] && FILES_FORMATTED="- Nenhum arquivo alterado"

          cat > "$DOC_FILE" <<- EOF
          	# $TICKET
          
          	## üì¶ Release $NEW_VERSION
          
          	**Data:** $DATE  
          	**Autor:** ${{ github.actor }}  
          	**Aprovadores:** ${{ steps.reviews.outputs.approved_by_csv }}  
          	**Pull Request:** [#${{ steps.pr.outputs.number }}](${{ steps.pr.outputs.url }})
          
          	---
          
          	## üìã Resumo da Release
          
          	**T√≠tulo:** $PR_TITLE
          
          	### Arquivos Alterados (${{ steps.code-analysis.outputs.file_count }})
          
          	$FILES_FORMATTED
          
          	### Estat√≠sticas de C√≥digo
          
          	- **Commits:** ${{ steps.code-analysis.outputs.commit_count }}
          	- **M√©todos/Fun√ß√µes:** ${{ steps.code-analysis.outputs.method_count }}
          	- **Linguagens:** ${{ steps.code-analysis.outputs.languages }}
          	- **Resumo:** ${{ steps.code-analysis.outputs.diff_stats }}
          
          	---
          
          	## üîç Como Validar
          
          	$HOW_TO_VALIDATE
          
          	---
          
          	## üí• Impacto
          
          	$IMPACT
          
          	---
          
          	## ‚Ü©Ô∏è Rollback
          
          	$ROLLBACK
          
          	---
          
          	## üîß Detalhes T√©cnicos
          
          	### Commits
          
          	$COMMITS_FORMATTED
          
          	### M√©todos/Fun√ß√µes Modificadas
          
          	$METHODS_FORMATTED
          
          	---
          
          	## üîó Links √öteis
          
          	- **Compara√ß√£o:** https://github.com/$REPO/compare/$BASE_SHA...$HEAD_SHA
          	- **Commit Base:** https://github.com/$REPO/commit/$BASE_SHA
          	- **Commit Head:** https://github.com/$REPO/commit/$HEAD_SHA
          	- **Vers√£o Anterior:** ${{ steps.meta.outputs.prev_version }}
          
          	---
          
            *Documenta√ß√£o gerada automaticamente em $DATE*
            EOF

          echo "Documenta√ß√£o gerada: $DOC_FILE"

      - name: Atualizar CHANGELOG
        shell: bash
        run: |
          set -euo pipefail

          NEW_VERSION="${{ steps.meta.outputs.new_version }}"
          DATE="${{ steps.meta.outputs.date }}"
          TICKET="${{ steps.validate-ticket.outputs.ticket }}"
          REPO="${{ steps.meta.outputs.repo }}"
          BASE_SHA="${{ steps.meta.outputs.base_sha }}"
          HEAD_SHA="${{ steps.meta.outputs.head_sha }}"

          PR_NUMBER="${{ steps.pr.outputs.number }}"
          PR_URL="${{ steps.pr.outputs.url }}"
          PR_TITLE="$(cat pr_title.txt)"

          if [ ! -f CHANGELOG.md ]; then
            {
              echo "# Changelog"
              echo ""
              echo "Todas as vers√µes not√°veis deste projeto ser√£o documentadas neste arquivo."
              echo ""
            } > CHANGELOG.md
          fi

          if grep -q "^## \[$NEW_VERSION\]" CHANGELOG.md; then
            echo "‚ö†Ô∏è Vers√£o $NEW_VERSION j√° registrada no changelog"
            exit 0
          fi

          TEMP_ENTRY="$(mktemp)"
          {
            echo "## [$NEW_VERSION] - $DATE"
            echo ""
            echo "### $PR_TITLE"
            echo ""
            echo "#### üé´ Ticket"
            echo "- $TICKET"
            echo ""
            echo "#### üìä Estat√≠sticas"
            echo "- Arquivos alterados: ${{ steps.code-analysis.outputs.file_count }}"
            echo "- Commits: ${{ steps.code-analysis.outputs.commit_count }}"
            echo "- M√©todos/Fun√ß√µes: ${{ steps.code-analysis.outputs.method_count }}"
            echo ""
            echo "#### ‚úÖ Aprova√ß√µes"
            echo "- Aprovadores: ${{ steps.reviews.outputs.approved_by_csv }}"
            echo ""
            echo "#### üîó Links"
            echo "- Pull Request: [#$PR_NUMBER]($PR_URL)"
            echo "- Compara√ß√£o: [$BASE_SHA...$HEAD_SHA](https://github.com/$REPO/compare/$BASE_SHA...$HEAD_SHA)"
            echo ""
          } > "$TEMP_ENTRY"

          awk -v entry_file="$TEMP_ENTRY" '
            NR==1 {print; print ""; system("cat " entry_file); next}
            {print}
          ' CHANGELOG.md > CHANGELOG.tmp

          mv CHANGELOG.tmp CHANGELOG.md
          rm -f "$TEMP_ENTRY"

          echo "CHANGELOG atualizado com vers√£o $NEW_VERSION"

      - name: Gerar JSON de codeChanges
        id: code-changes
        shell: bash
        run: |
          set -euo pipefail

          export BASE_SHA="${{ steps.meta.outputs.base_sha }}"
          export HEAD_SHA="${{ steps.meta.outputs.head_sha }}"

          python3 - << 'PYTHON_SCRIPT' > code_changes.json
          import json
          import os
          import re
          import subprocess

          base_sha = os.environ.get("BASE_SHA")
          head_sha = os.environ.get("HEAD_SHA")

          try:
              diff = subprocess.check_output(
                  ["git", "diff", "-U0", base_sha, head_sha],
                  text=True
              )
          except Exception:
              diff = ""

          changes = []
          current_file = None
          current_line = None

          method_patterns = [
              r'^\+\s*(function\s+\w+\s*\()',
              r'^\+\s*(const\s+\w+\s*=\s*\([^)]*\)\s*=>)',
              r'^\+\s*(let\s+\w+\s*=\s*\([^)]*\)\s*=>)',
              r'^\+\s*(class\s+\w+)',
              r'^\+\s*(def\s+\w+\s*\()',
              r'^\+\s*(\w+\s*=\s*function\s*\()',
              r'^\+\s*(async\s+function\s+\w+\s*\()',
              r'^\+\s*(async\s+\w+\s*=\s*\([^)]*\)\s*=>)',
              r'^\+\s*(\w+\s*:\s*function\s*\()',
              r'^\+\s*(\w+\s*\([^)]*\)\s*{)',
          ]

          line_pattern = re.compile(r"^@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@")

          for line in diff.split("\n"):
              if line.startswith("+++ b/"):
                  current_file = line[6:]
                  continue

              m = line_pattern.match(line)
              if m:
                  current_line = int(m.group(1))
                  continue

              if line.startswith("+") and not line.startswith("+++"):
                  if current_line is None or not current_file:
                      continue

                  code = line[1:].rstrip()
                  if not code.strip():
                      current_line += 1
                      continue

                  change_type = "Alteracao"
                  for pattern in method_patterns:
                      if re.search(pattern, code, re.IGNORECASE):
                          change_type = "Classe" if "class" in pattern else "Funcao/Metodo"
                          break

                  changes.append({
                      "type": change_type,
                      "file": current_file,
                      "lineStart": current_line,
                      "lineEnd": current_line,
                      "code": code.strip(),
                      "commit": head_sha,
                      "language": os.path.splitext(current_file)[1][1:] or "unknown"
                  })
                  current_line += 1

                  changes = changes[:50]
                  print(json.dumps(changes, ensure_ascii=False))
                  PYTHON_SCRIPT

          echo "Code changes JSON gerado"

      - name: Gerar releases.json para front-end
        shell: bash
        run: |
          set -euo pipefail

          NEW_VERSION="${{ steps.meta.outputs.new_version }}"
          DATE="${{ steps.meta.outputs.date }}"
          TIMESTAMP="${{ steps.meta.outputs.timestamp }}"
          TICKET="${{ steps.validate-ticket.outputs.ticket }}"
          REPO="${{ steps.meta.outputs.repo }}"
          BASE_SHA="${{ steps.meta.outputs.base_sha }}"
          HEAD_SHA="${{ steps.meta.outputs.head_sha }}"
          YEAR="${{ steps.meta.outputs.year }}"
          MONTH="${{ steps.meta.outputs.month }}"
          PREV_VERSION="${{ steps.meta.outputs.prev_version }}"

          APPROVED_BY_JSON='${{ steps.reviews.outputs.approved_by_json }}'
          CHANGED_FILES_JSON='${{ steps.code-analysis.outputs.changed_files_json }}'
          CODE_CHANGES_JSON="$(jq -c . code_changes.json)"

          FILE_LINKS_JSON="$(echo "$CHANGED_FILES_JSON" | jq -c --arg repo "$REPO" --arg sha "$HEAD_SHA" '
            map({ path: ., url: ("https://github.com/" + $repo + "/blob/" + $sha + "/" + .) })
          ')"

          DOC_PATH="docs/releases/$YEAR/$MONTH/${TICKET}.md"
          DOC_URL="https://github.com/$REPO/blob/$HEAD_SHA/$DOC_PATH"
          CHANGELOG_PATH="CHANGELOG.md"
          CHANGELOG_URL="https://github.com/$REPO/blob/$HEAD_SHA/$CHANGELOG_PATH"

          mkdir -p docs
          RELEASES_FILE="docs/releases.json"

          if [ ! -f "$RELEASES_FILE" ]; then
            echo '{"releases":[], "metadata":{"lastUpdated":"", "totalReleases":0}}' > "$RELEASES_FILE"
          fi

          NEW_RELEASE="$(jq -n \
            --arg version "$NEW_VERSION" \
            --arg date "$DATE" \
            --arg timestamp "$TIMESTAMP" \
            --arg ticket "$TICKET" \
            --arg author "${{ github.actor }}" \
            --argjson approvedBy "$APPROVED_BY_JSON" \
            --arg prNumber "${{ steps.pr.outputs.number }}" \
            --arg prTitle "$(cat pr_title.txt)" \
            --arg prUrl "${{ steps.pr.outputs.url }}" \
            --arg baseSha "$BASE_SHA" \
            --arg headSha "$HEAD_SHA" \
            --arg compareUrl "https://github.com/$REPO/compare/$BASE_SHA...$HEAD_SHA" \
            --arg previousVersion "$PREV_VERSION" \
            --arg changeLogPath "$CHANGELOG_PATH" \
            --arg changeLogUrl "$CHANGELOG_URL" \
            --arg releaseDocPath "$DOC_PATH" \
            --arg releaseDocUrl "$DOC_URL" \
            --argjson changedFiles "$CHANGED_FILES_JSON" \
            --argjson fileLinks "$FILE_LINKS_JSON" \
            --argjson codeChanges "$CODE_CHANGES_JSON" \
            --arg fileCount "${{ steps.code-analysis.outputs.file_count }}" \
            --arg commitCount "${{ steps.code-analysis.outputs.commit_count }}" \
            --arg methodCount "${{ steps.code-analysis.outputs.method_count }}" \
            '{
              version: $version,
              date: $date,
              timestamp: $timestamp,
              ticket: $ticket,
              author: $author,
              approvedBy: $approvedBy,
              pr: { number: $prNumber, title: $prTitle, url: $prUrl },
              commits: { base: $baseSha, head: $headSha, compareUrl: $compareUrl, previousVersion: $previousVersion },
              docs: { changeLogPath: $changeLogPath, changeLogUrl: $changeLogUrl, releaseDocPath: $releaseDocPath, releaseDocUrl: $releaseDocUrl },
              stats: { fileCount: $fileCount, commitCount: $commitCount, methodCount: $methodCount },
              changedFiles: $changedFiles,
              fileLinks: $fileLinks,
              codeChanges: $codeChanges
            }')"

          TMP_FILE="$(mktemp)"
          jq --argjson newRelease "$NEW_RELEASE" --arg timestamp "$TIMESTAMP" '
            .metadata.lastUpdated = $timestamp |
            .releases = [$newRelease] + (.releases | map(select(.version != $newRelease.version))) |
            .releases = (.releases | sort_by(.timestamp) | reverse) |
            .metadata.totalReleases = (.releases | length)
          ' "$RELEASES_FILE" > "$TMP_FILE"

          mv "$TMP_FILE" "$RELEASES_FILE"
          echo "releases.json atualizado com vers√£o $NEW_VERSION"

      - name: Gerar preview da release (opcional)
        if: github.event.pull_request.draft == false
        shell: bash
        run: |
          set -euo pipefail

          PREVIEW_FILE="$(mktemp)"

          cat > "$PREVIEW_FILE" <<- EOF
          	## üöÄ Release ${{ steps.meta.outputs.new_version }} - Preview
          
          	| Item | Detalhe |
          	|------|---------|
          	| Vers√£o | ${{ steps.meta.outputs.new_version }} |
          	| Ticket | ${{ steps.validate-ticket.outputs.ticket }} |
          	| Autor | ${{ github.actor }} |
          	| Aprovadores | ${{ steps.reviews.outputs.approved_by_csv }} |
          	| Arquivos | ${{ steps.code-analysis.outputs.file_count }} |
          	| Commits | ${{ steps.code-analysis.outputs.commit_count }} |
          
          	**üìä Documenta√ß√£o Gerada**
          	- üìÑ Documento: https://github.com/${{ github.repository }}/blob/${{ steps.meta.outputs.head_sha }}/docs/releases/${{ steps.meta.outputs.year }}/${{ steps.meta.outputs.month }}/${{ steps.validate-ticket.outputs.ticket }}.md
          	- üìö CHANGELOG: https://github.com/${{ github.repository }}/blob/${{ steps.meta.outputs.head_sha }}/CHANGELOG.md
          	- üóÇÔ∏è Releases: https://github.com/${{ github.repository }}/blob/${{ steps.meta.outputs.head_sha }}/docs/releases.json
          	EOF

          echo "‚úÖ Preview gerado"

      - name: Commit e push das mudan√ßas
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/releases/ docs/releases.json CHANGELOG.md

          if git diff --staged --quiet; then
            echo "Nenhuma mudan√ßa para commitar"
            exit 0
          fi

          git commit -m "docs: release ${{ steps.meta.outputs.new_version }} - ${{ steps.validate-ticket.outputs.ticket }}"

          git pull --rebase origin "${{ github.event.pull_request.head.ref }}"
          git push origin "HEAD:${{ github.event.pull_request.head.ref }}"

          echo "Mudan√ßas commitadas e enviadas"

      - name: Sum√°rio da execu√ß√£o
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          {
            echo "## Resumo da Documenta√ß√£o Gerada"
            echo ""
            echo "| Item | Detalhe |"
            echo "|------|---------|"
            echo "| **Vers√£o** | ${{ steps.meta.outputs.new_version }} |"
            echo "| **Ticket** | ${{ steps.validate-ticket.outputs.ticket }} |"
            echo "| **Autor** | ${{ github.actor }} |"
            echo "| **Aprovadores** | ${{ steps.reviews.outputs.approved_by_csv }} |"
            echo "| **Arquivos** | ${{ steps.code-analysis.outputs.file_count }} |"
            echo "| **Commits** | ${{ steps.code-analysis.outputs.commit_count }} |"
            echo "| **M√©todos** | ${{ steps.code-analysis.outputs.method_count }} |"
            echo ""
            echo "### üìÅ Arquivos Gerados"
            echo ""
            echo "- Documento: https://github.com/${{ github.repository }}/blob/${{ steps.meta.outputs.head_sha }}/docs/releases/${{ steps.meta.outputs.year }}/${{ steps.meta.outputs.month }}/${{ steps.validate-ticket.outputs.ticket }}.md"
            echo "- CHANGELOG: https://github.com/${{ github.repository }}/blob/${{ steps.meta.outputs.head_sha }}/CHANGELOG.md"
            echo "- releases.json: https://github.com/${{ github.repository }}/blob/${{ steps.meta.outputs.head_sha }}/docs/releases.json"
          } >> "$GITHUB_STEP_SUMMARY"
