name: ðŸš€ Change Control & Documentation

on:
  pull_request:
    branches:
      - main
      - master
    types: [opened, edited, synchronize, reopened, ready_for_review]

# PermissÃµes necessÃ¡rias
permissions:
  contents: write
  pull-requests: read
  issues: read

jobs:
  generate-documentation:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # âœ… LÃª title/body do PR com seguranÃ§a (evita executar texto do PR no bash)
      - name: ðŸ”’ Ler dados do PR (safe)
        id: pr
        shell: bash
        run: |
          set -euo pipefail
          PR_TITLE="$(jq -r '.pull_request.title // ""' "$GITHUB_EVENT_PATH")"
          PR_BODY="$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")"
          PR_NUMBER="$(jq -r '.pull_request.number // ""' "$GITHUB_EVENT_PATH")"
          PR_URL="$(jq -r '.pull_request.html_url // ""' "$GITHUB_EVENT_PATH")"

          {
            echo "title<<EOF"
            printf '%s\n' "$PR_TITLE"
            echo "EOF"
            echo "body<<EOF"
            printf '%s\n' "$PR_BODY"
            echo "EOF"
            echo "number=$PR_NUMBER"
            echo "url=$PR_URL"
          } >> "$GITHUB_OUTPUT"

      - name: ðŸ” Validar ticket GLPI
        id: validate-ticket
        shell: bash
        run: |
          set -euo pipefail

          PR_TITLE="${{ steps.pr.outputs.title }}"
          PR_BODY="${{ steps.pr.outputs.body }}"

          # Extrai o primeiro ticket GLPI encontrado
          TICKET="$(printf '%s\n' "$PR_TITLE $PR_BODY" | grep -oE "GLPI-[0-9]+" | head -n 1 || true)"

          if [ -z "$TICKET" ]; then
            echo "âŒ ERRO: O PR deve conter um ticket GLPI-XXXX no tÃ­tulo ou descriÃ§Ã£o."
            exit 1
          fi

          echo "ticket=$TICKET" >> "$GITHUB_OUTPUT"
          echo "âœ… Ticket encontrado: $TICKET"

      - name: ðŸ“‹ Validar campos obrigatÃ³rios
        shell: bash
        run: |
          set -euo pipefail

          BODY="${{ steps.pr.outputs.body }}"

          check_section() {
            local section="$1"
            if ! printf '%s\n' "$BODY" | grep -iE "^###?[[:space:]]*$section[[:space:]]*$" > /dev/null; then
              echo "âŒ ERRO: SeÃ§Ã£o '$section' Ã© obrigatÃ³ria no PR."
              exit 1
            fi
          }

          check_section "Como validar"
          check_section "Rollback"
          check_section "Impacto"

          echo "âœ… Todos os campos obrigatÃ³rios estÃ£o presentes"

      - name: ðŸ“Š Extrair metadados da release
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          DATE="$(date +%Y-%m-%d)"
          YEAR="$(date +%Y)"
          MONTH="$(date +%m)"
          TIMESTAMP="$(date +%s)"

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          REPO="${{ github.repository }}"

          LAST_VERSION=""
          if [ -f CHANGELOG.md ]; then
            LAST_VERSION="$(grep -m 1 -oE '## \[v[0-9]+\.[0-9]+\.[0-9]+\]' CHANGELOG.md \
              | sed -E 's/## \[(v[0-9]+\.[0-9]+\.[0-9]+)\]/\1/' || true)"
          fi

          if [ -z "$LAST_VERSION" ]; then
            MAJOR="0"
            MINOR="1"
            PATCH="0"
          else
            MAJOR="$(echo "$LAST_VERSION" | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\1/')"
            MINOR="$(echo "$LAST_VERSION" | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\2/')"
            PATCH="$(echo "$LAST_VERSION" | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\3/')"
            PATCH="$((PATCH + 1))"
          fi

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          PREV_VERSION="${LAST_VERSION:-N/A}"

          RELEASE_NAME="Release ${NEW_VERSION} - ${{ steps.pr.outputs.title }}"

          {
            echo "date=$DATE"
            echo "year=$YEAR"
            echo "month=$MONTH"
            echo "timestamp=$TIMESTAMP"
            echo "base_sha=$BASE_SHA"
            echo "head_sha=$HEAD_SHA"
            echo "repo=$REPO"
            echo "new_version=$NEW_VERSION"
            echo "prev_version=$PREV_VERSION"
            echo "release_name=$RELEASE_NAME"
          } >> "$GITHUB_OUTPUT"

          echo "âœ… Metadados gerados: $NEW_VERSION"

      - name: ðŸ‘¥ Coletar aprovaÃ§Ãµes
        id: reviews
        shell: bash
        run: |
          set -euo pipefail

          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.pr.outputs.number }}/reviews"

          REVIEWS="$(curl -sS \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL")"

          APPROVED_BY_JSON="$(echo "$REVIEWS" | jq -c '[.[] | select(.state == "APPROVED") | .user.login] | unique')"
          APPROVED_COUNT="$(echo "$APPROVED_BY_JSON" | jq 'length')"

          if [ "$APPROVED_COUNT" -eq 0 ]; then
            APPROVED_BY_CSV="Aguardando aprovaÃ§Ãµes"
            APPROVED_BY_JSON='[]'
          else
            APPROVED_BY_CSV="$(echo "$APPROVED_BY_JSON" | jq -r 'join(", ")')"
          fi

          {
            echo "approved_by_json=$APPROVED_BY_JSON"
            echo "approved_by_csv=$APPROVED_BY_CSV"
            echo "approved_count=$APPROVED_COUNT"
          } >> "$GITHUB_OUTPUT"

          echo "âœ… Aprovadores: $APPROVED_BY_CSV"

      - name: ðŸ”§ Analisar alteraÃ§Ãµes de cÃ³digo
        id: code-analysis
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ steps.meta.outputs.base_sha }}"
          HEAD_SHA="${{ steps.meta.outputs.head_sha }}"

          CHANGED_FILES="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | sort -u || true)"
          FILE_COUNT="$(printf '%s\n' "$CHANGED_FILES" | sed '/^\s*$/d' | wc -l | tr -d ' ')"

          DIFF_STATS="$(git diff --shortstat "$BASE_SHA" "$HEAD_SHA" || true)"
          [ -z "$DIFF_STATS" ] && DIFF_STATS="0 files changed"

          COMMITS="$(git log --pretty=format:"%h - %s (%an)" "$BASE_SHA..$HEAD_SHA" || true)"
          COMMIT_COUNT="$(git rev-list --count "$BASE_SHA..$HEAD_SHA" || echo 0)"

          METHODS_ANALYSIS="$(git diff -U0 "$BASE_SHA" "$HEAD_SHA" \
            | grep -E '^\+.*(function|def|class|const|let|var|async|=>)' \
            | sed 's/^+//' | grep -v '^\s*$' | head -20 || true)"
          METHOD_COUNT="$(printf '%s\n' "$METHODS_ANALYSIS" | sed '/^\s*$/d' | wc -l | tr -d ' ')"

          LANGUAGES="$(git ls-files | grep -v '^docs/' | sed 's/.*\.//' | sort -u | tr '\n' ', ' | sed 's/, $//')"
          FILES_JSON="$(printf '%s\n' "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')"
          FILE_STATS="$(git diff --numstat "$BASE_SHA" "$HEAD_SHA" | awk '{print $1":"$2":"$3}' | tr '\n' '|' || true)"

          {
            echo "changed_files_json=$FILES_JSON"
            echo "file_count=$FILE_COUNT"
            echo "diff_stats=$DIFF_STATS"
            echo "commit_count=$COMMIT_COUNT"
            echo "method_count=$METHOD_COUNT"
            echo "languages=$LANGUAGES"
            echo "file_stats=$FILE_STATS"
          } >> "$GITHUB_OUTPUT"

          printf '%s\n' "$COMMITS" > commits.txt
          printf '%s\n' "$METHODS_ANALYSIS" > methods.txt

          echo "âœ… AnÃ¡lise de cÃ³digo concluÃ­da: $FILE_COUNT arquivos, $COMMIT_COUNT commits"

      - name: ðŸ“ Extrair seÃ§Ãµes do PR
        id: extract-sections
        shell: bash
        run: |
          set -euo pipefail

          PR_BODY="${{ steps.pr.outputs.body }}"

          extract_section() {
            local section="$1"
            printf '%s\n' "$PR_BODY" | awk -v title="$section" '
              BEGIN {found=0; IGNORECASE=1}
              tolower($0) ~ "^#+[[:space:]]*" tolower(title) "[[:space:]]*$" {found=1; next}
              found && /^#+[[:space:]]/ {exit}
              found {print}
            ' | sed '/^$/d' | head -20
          }

          HOW_TO_VALIDATE="$(extract_section "Como validar" | head -10)"
          IMPACT="$(extract_section "Impacto" | head -10)"
          ROLLBACK="$(extract_section "Rollback" | head -10)"

          [ -z "$HOW_TO_VALIDATE" ] && HOW_TO_VALIDATE="*Nenhum roteiro de validaÃ§Ã£o fornecido. Recomenda-se adicionar casos de teste.*"
          [ -z "$IMPACT" ] && IMPACT="*Impacto nÃ£o descrito. Favor documentar o impacto desta mudanÃ§a.*"
          [ -z "$ROLLBACK" ] && ROLLBACK="*EstratÃ©gia de rollback nÃ£o documentada. Recomenda-se definir plano de reversÃ£o.*"

          printf '%s\n' "$HOW_TO_VALIDATE" > how_to_validate.txt
          printf '%s\n' "$IMPACT" > impact.txt
          printf '%s\n' "$ROLLBACK" > rollback.txt

          echo "âœ… SeÃ§Ãµes extraÃ­das com sucesso"

      - name: ðŸŽ¨ Gerar documentaÃ§Ã£o markdown
        shell: bash
        run: |
          set -euo pipefail

          YEAR="${{ steps.meta.outputs.year }}"
          MONTH="${{ steps.meta.outputs.month }}"
          TICKET="${{ steps.validate-ticket.outputs.ticket }}"
          NEW_VERSION="${{ steps.meta.outputs.new_version }}"
          DATE="${{ steps.meta.outputs.date }}"
          REPO="${{ steps.meta.outputs.repo }}"
          BASE_SHA="${{ steps.meta.outputs.base_sha }}"
          HEAD_SHA="${{ steps.meta.outputs.head_sha }}"

          DOC_DIR="docs/releases/$YEAR/$MONTH"
          mkdir -p "$DOC_DIR"
          DOC_FILE="$DOC_DIR/${TICKET}.md"

          HOW_TO_VALIDATE="$(cat how_to_validate.txt)"
          IMPACT="$(cat impact.txt)"
          ROLLBACK="$(cat rollback.txt)"
          COMMITS="$(cat commits.txt)"
          METHODS="$(cat methods.txt)"
          CHANGED_FILES='${{ steps.code-analysis.outputs.changed_files_json }}'

          METHODS_FORMATTED="$(printf '%s\n' "$METHODS" | sed 's/^/- /')"
          [ -z "$(echo "$METHODS_FORMATTED" | tr -d '[:space:]')" ] && METHODS_FORMATTED="- Nenhum mÃ©todo/funÃ§Ã£o novo identificado"

          COMMITS_FORMATTED="$(printf '%s\n' "$COMMITS" | sed 's/^/- /')"
          [ -z "$(echo "$COMMITS_FORMATTED" | tr -d '[:space:]')" ] && COMMITS_FORMATTED="- Nenhum commit no intervalo"

          FILES_FORMATTED="$(echo "$CHANGED_FILES" | jq -r '.[]' | sed 's/^/- ðŸ“„ /')"
          [ -z "$(echo "$FILES_FORMATTED" | tr -d '[:space:]')" ] && FILES_FORMATTED="- Nenhum arquivo alterado"

            cat > "$DOC_FILE" <<- 'EOF'
            	# $TICKET
          
            	## ðŸ“¦ Release $NEW_VERSION
          
            	**Data:** $DATE  
            	**Autor:** ${{ github.actor }}  
            	**Aprovadores:** ${{ steps.reviews.outputs.approved_by_csv }}  
            	**Pull Request:** [#${{ steps.pr.outputs.number }}](${{ steps.pr.outputs.url }})
          
            	---
          
            	## ðŸ“‹ Resumo da Release
          
            	**TÃ­tulo:** ${{ steps.pr.outputs.title }}
          
            	### Arquivos Alterados (${{ steps.code-analysis.outputs.file_count }})
          
            	$FILES_FORMATTED
          
            	### EstatÃ­sticas de CÃ³digo
          
            	- Commits: ${{ steps.code-analysis.outputs.commit_count }}
            	- MÃ©todos/FunÃ§Ãµes: ${{ steps.code-analysis.outputs.method_count }}
            	- Linguagens: ${{ steps.code-analysis.outputs.languages }}
            	- Resumo: ${{ steps.code-analysis.outputs.diff_stats }}
          
            	---
          
            	## ðŸ” Como Validar
          
            	$HOW_TO_VALIDATE
          
            	---
          
            	## ðŸ’¥ Impacto
          
            	$IMPACT
          
            	---
          
            	## â†©ï¸ Rollback
          
            	$ROLLBACK
          
            	---
          
            	## ðŸ”§ Detalhes TÃ©cnicos
          
            	### Commits
          
            	$COMMITS_FORMATTED
          
            	### MÃ©todos/FunÃ§Ãµes Modificadas
          
            	$METHODS_FORMATTED
          
            	---
          
            	## ðŸ”— Links Ãšteis
          
            	- **ComparaÃ§Ã£o:** \`$BASE_SHA...$HEAD_SHA\` (https://github.com/$REPO/compare/$BASE_SHA...$HEAD_SHA)
            	- **Commit Base:** \`$BASE_SHA\` (https://github.com/$REPO/commit/$BASE_SHA)
            	- **Commit Head:** \`$HEAD_SHA\` (https://github.com/$REPO/commit/$HEAD_SHA)
            	- **VersÃ£o Anterior:** ${{ steps.meta.outputs.prev_version }}
          
            	---
          
            	*DocumentaÃ§Ã£o gerada au*
            	EOF
